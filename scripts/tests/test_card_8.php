<?php

require __DIR__.'/vendor/autoload.php';

use PhpOffice\PhpWord\IOFactory;

$filePath = "PetBasedoc/Вакцина №1 от 02.09.25г Собак           9 шт/08_№ 3524 вольер №81.docx";

echo "Тестирование парсинга карточки №8\n";
echo str_repeat('=', 70) . "\n\n";

// Извлекаем текст альтернативным методом
function extractTextAlternative($filePath) {
    $zip = new \ZipArchive();
    if ($zip->open($filePath) === true) {
        $xml = $zip->getFromName('word/document.xml');
        $zip->close();
        
        if ($xml) {
            $dom = new \DOMDocument();
            @$dom->loadXML($xml);
            
            $text = '';
            $paragraphs = $dom->getElementsByTagName('p');
            foreach ($paragraphs as $paragraph) {
                $textNodes = $paragraph->getElementsByTagName('t');
                $paragraphText = '';
                foreach ($textNodes as $textNode) {
                    $paragraphText .= $textNode->nodeValue;
                }
                if (!empty($paragraphText)) {
                    $text .= $paragraphText . "\n";
                }
            }
            
            return $text;
        }
    }
    
    return null;
}

$text = extractTextAlternative($filePath);

if (!$text) {
    echo "Ошибка: не удалось извлечь текст\n";
    exit(1);
}

echo "Длина текста: " . strlen($text) . " символов\n\n";

// Парсим все поля
$fields = [
    'Номер карточки' => '/№\s*(\d+)\s+/',
    'Дата карточки' => '/№\s*\d+\s+([\d\s]+(?:ноября|января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|декабря)\s+\d{4})/ui',
    'Категория' => '/категория\s+животного[:\s]+(собака|кошка)/ui',
    'Дата поступления' => '/дата\s+поступления[:\s]+([\d.]+)/ui',
    'Пол' => '/пол[:\s]+(кобель|сука|кот|кошка)/ui',
    'Порода' => '/порода[:\s]+(.+?)(?:окрас|$)/ui',
    'Окрас' => '/окрас[:\s]+(.+?)(?:шерсть|$)/ui',
    'Шерсть' => '/шерсть[:\s]+(.+?)(?:уши|$)/ui',
    'Уши' => '/уши[:\s]+(.+?)(?:хвост|$)/ui',
    'Хвост' => '/хвост[:\s]+(.+?)(?:размер|$)/ui',
    'Размер' => '/размер[:\s]+(.+?)(?:\d+\s*кг|возраст|$)/ui',
    'Вес' => '/размер[:\s]+.+?(\d+)\s*кг/ui',
    'Возраст' => '/возраст[:\s\(]*примерный[:\s\)]*[:\s]+(.+?)(?:особые|$)/ui',
    'Особые приметы' => '/особые\s+приметы[:\s]+(.+?)(?:акт|$)/ui',
    'Акт №' => '/акт\s+(?:приёма-передачи|отлова)[:\s]+(?:животного[:\s]+)?№?\s*(\d+)/ui',
    'Дата акта' => '/акт\s+(?:приёма-передачи|отлова)[:\s]+(?:животного[:\s]+)?№?\s*\d+\s+от\s+([\d.]+)/ui',
    'ВСД' => '/ВСД\s*\(дата[,\s]+№\)[:\s]+(.+?)(?:адрес\s+и\s+описание|$)/ui',
    'Место отлова' => '/адрес\s+и\s+описание\s+места\s+отлова[:\s]+(.+?)(?:дата\s+клинического|$)/ui',
    'Клинический осмотр' => '/дата\s+клинического\s+осмотра[,\s]+заключение[:\s]+(.+?)(?:информация|$)/ui',
    'Агрессивное поведение' => '/информация\s+о\s+наличии.*агрессивного\s+поведения[:\s]+(.+?)(?:информация\s+о\s+мероприятиях|$)/ui',
    'Коррекция поведения' => '/мероприятиях\s+по\s+корректировке\s+поведения[:\s]+(.+?)(?:вакцинация|$)/ui',
    'Вакцинация' => '/вакцинация[,\s]+вид\s+прививки[,\s]+акт[:\s\(]+дата[,\s]+№[:\s\)]+(.+?)(?:дата\s+дегельминтизации|$)/ui',
    'Дегельминтизация' => '/дата\s+дегельминтизации[:\s]+([\d.]+)/ui',
    'Стерилизация' => '/дата\s+стерилизации[:\s]+([\d.]+)/ui',
    'Ветеринар' => '/специалиста.*стерилизации[:\s]+(.+?)(?:дата\s+маркирования|$)/ui',
    'Дата маркирования' => '/дата\s+маркирования[:\s]+([\d.]+)/ui',
    'Бирка' => '/№\s+бирки[:\s\(]*клейма[:\s\)]*[:\s]+(.+?)(?:№\s+чипа|$)/ui',
    'Чип' => '/№\s+чипа[:\s]+([\d\s]+?)(?:наличие|$)/ui',
    'Акт агрессивности' => '/наличие\/отсутствие\s+немотивированной\s+агрессивности[,\s]+акт[:\s\(]*дата[,\s]+N[:\s\)]*[:\s]+(.+?)(?:выбытие|$)/ui',
    'Выбытие' => '/выбытие\s*\(причина[,\s]+дата\)[:\s]+(.+?)(?:ветеринарный|$)/ui',
    'Вет. документ' => '/ветеринарный\s+сопроводительный\s+документ\s*\(дата[,\s]+№\)[:\s]+(.+?)(?:адрес\s+и\s+описание|$)/ui',
    'Адрес возврата' => '/адрес\s+и\s+описание\s+места\s+возвращения[:\s\(]*размещения[:\s\)]*[:\s]+(.+?)$/ui',
];

foreach ($fields as $name => $pattern) {
    if (preg_match($pattern, $text, $matches)) {
        $value = isset($matches[1]) ? trim($matches[1]) : 'найдено';
        // Обрезаем длинные значения
        if (strlen($value) > 60) {
            $value = mb_substr($value, 0, 60) . '...';
        }
        echo "✅ $name: $value\n";
    } else {
        echo "❌ $name: НЕ НАЙДЕНО\n";
    }
}

echo "\n" . str_repeat('=', 70) . "\n";
echo "Парсинг завершен!\n";
