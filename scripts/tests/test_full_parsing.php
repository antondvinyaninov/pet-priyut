<?php

$text = "№ 8 26 ноября 2024г.Категория животного: собакаДата поступления: 26 ноября 2024г.Пол: кобельПорода: беспороднаяОкрас: чёрно-рыжийШерсть: средняяУши: стоячиеХвост: прямойРазмер: средний 20 кгВозраст (примерный): 4 года.Особые приметы: белые лапы, шея и мордаАкт приёма-передачи животного: № 25 от 26.11.2024г.ВСД (дата, №): –Адрес и описание места отлова: г. Воронеж, пер. Фабричный, д. 8Дата клинического осмотра, заключение: 26 ноября 2024г. клинически здоровИнформация о наличии (отсутствии) у животного агрессивного поведения: проявляет признаки немотивированной агрессивности 26.11.2024г.,- лает, 29.01.2025г. - рычит 31.03.2025г – скалится, 13.05.2025г. – рычит, 30.06.2025г – скалится.Информация о мероприятиях по корректировке поведения животного: не проводилисьВакцинация, вид прививки, акт (дата, №) № 40 от 04.10.2024г. Рабикан серия № 4031 изготовлена 05.2024Дата дегельминтизации: 25.09.2024г.Дата стерилизации: 12.05.2023г.Ф.И.О. специалиста в области ветеринарии, произведшего операцию стерилизации:Вязьмина В.ГДата маркирования: 12.05.2023г.№ бирки (клейма): № 3524, левое ухо, красная бирка№ чипа: 643110800498435Наличие/отсутствие немотивированной агрессивности, акт (дата, N): –Выбытие (причина, дата): –Ветеринарный сопроводительный документ (дата, №): – Адрес и описание места возвращения (размещения): –";

echo "Проверка парсинга всех полей:\n";
echo str_repeat('=', 70) . "\n\n";

$fields = [
    'Номер карточки' => '/№\s*(\d+)\s+/',
    'Дата карточки' => '/№\s*\d+\s+([\d\s]+(?:ноября|января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|декабря)\s+\d{4})/ui',
    'Категория' => '/категория\s+животного[:\s]+(собака|кошка)/ui',
    'Дата поступления' => '/дата\s+поступления[:\s]+([\d\s]+(?:ноября|января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|декабря)\s+\d{4})/ui',
    'Пол' => '/пол[:\s]+(кобель|сука|кот|кошка)/ui',
    'Порода' => '/порода[:\s]+(.+?)(?:окрас|$)/ui',
    'Окрас' => '/окрас[:\s]+(.+?)(?:шерсть|$)/ui',
    'Шерсть' => '/шерсть[:\s]+(.+?)(?:уши|$)/ui',
    'Уши' => '/уши[:\s]+(.+?)(?:хвост|$)/ui',
    'Хвост' => '/хвост[:\s]+(.+?)(?:размер|$)/ui',
    'Размер' => '/размер[:\s]+(.+?)(?:\d+\s*кг|возраст|$)/ui',
    'Вес' => '/размер[:\s]+.+?(\d+)\s*кг/ui',
    'Возраст' => '/возраст[:\s\(]*примерный[:\s\)]*[:\s]+(.+?)(?:особые|$)/ui',
    'Особые приметы' => '/особые\s+приметы[:\s]+(.+?)(?:акт|$)/ui',
    'Акт №' => '/акт\s+(?:приёма-передачи|отлова)[:\s]+(?:животного[:\s]+)?№?\s*(\d+)/ui',
    'Дата акта' => '/акт\s+(?:приёма-передачи|отлова)[:\s]+(?:животного[:\s]+)?№?\s*\d+\s+от\s+([\d.]+)/ui',
    'Место отлова' => '/адрес\s+и\s+описание\s+места\s+отлова[:\s]+(.+?)(?:дата\s+клинического|$)/ui',
    'Клинический осмотр дата' => '/дата\s+клинического\s+осмотра[,\s]+заключение[:\s]+([\d\s]+(?:ноября|января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|декабря)\s+\d{4})/ui',
    'Клинический осмотр заключение' => '/дата\s+клинического\s+осмотра[,\s]+заключение[:\s]+[\d\s]+(?:ноября|января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|декабря)\s+\d{4}\s*г?\.?\s+(.+?)(?:информация|$)/ui',
    'Агрессивное поведение' => '/информация\s+о\s+наличии.*агрессивного\s+поведения[:\s]+(.+?)(?:информация\s+о\s+мероприятиях|$)/ui',
    'Коррекция поведения' => '/мероприятиях\s+по\s+корректировке\s+поведения[:\s]+(.+?)(?:вакцинация|$)/ui',
    'Вакцинация акт' => '/вакцинация[,\s]+вид\s+прививки[,\s]+акт[:\s\(]+дата[,\s]+№[:\s\)]+№?\s*(\d+)/ui',
    'Вакцинация дата' => '/вакцинация[,\s]+вид\s+прививки[,\s]+акт[:\s\(]+дата[,\s]+№[:\s\)]+№?\s*\d+\s+от\s+([\d.]+)/ui',
    'Вакцина название' => '/вакцинация[,\s]+вид\s+прививки[,\s]+акт[:\s\(]+дата[,\s]+№[:\s\)]+№?\s*\d+\s+от\s+[\d.]+\s*г?\.?\s+(.+?)(?:серия|дата\s+дегельминтизации|$)/ui',
    'Дегельминтизация' => '/дата\s+дегельминтизации[:\s]+([\d.]+)/ui',
    'Стерилизация' => '/дата\s+стерилизации[:\s]+([\d.]+)/ui',
    'Ветеринар' => '/специалиста.*стерилизации[:\s]+(.+?)(?:дата\s+маркирования|$)/ui',
    'Дата маркирования' => '/дата\s+маркирования[:\s]+([\d.]+)/ui',
    'Бирка' => '/№\s+бирки[:\s\(]*клейма[:\s\)]*[:\s]+№?\s*(\d+)/ui',
    'Чип' => '/№\s+чипа[:\s]+([\d\s]+)/ui',
];

foreach ($fields as $name => $pattern) {
    if (preg_match($pattern, $text, $matches)) {
        $value = isset($matches[1]) ? trim($matches[1]) : 'найдено';
        echo "✅ $name: $value\n";
    } else {
        echo "❌ $name: НЕ НАЙДЕНО\n";
    }
}

// Дополнительные поля
if (preg_match('/ВСД\s*\(дата[,\s]+№\)[:\s]+(?:от\s+)?([\d.]+)\s*г?\.?\s*№?\s*(\d+)/ui', $text, $matches)) {
    echo "✅ ВСД дата: " . $matches[1] . "\n";
    echo "✅ ВСД номер: " . $matches[2] . "\n";
} elseif (preg_match('/ВСД\s*\(дата[,\s]+№\)[:\s]+№?\s*(\d+)\s+от\s+([\d.]+)/ui', $text, $matches)) {
    echo "✅ ВСД номер: " . $matches[1] . "\n";
    echo "✅ ВСД дата: " . $matches[2] . "\n";
} else {
    echo "✅ ВСД: не указан (–)\n";
}

if (preg_match('/наличие\/отсутствие\s+немотивированной\s+агрессивности[,\s]+акт[:\s\(]*дата[,\s]+N[:\s\)]*[:\s]+(.+?)(?:выбытие|ветеринарный|$)/ui', $text, $matches)) {
    $aggr = trim($matches[1]);
    if (!in_array(mb_strtolower($aggr), ['нет', '-', '–', ''])) {
        echo "✅ Акт агрессивности: " . mb_substr($aggr, 0, 60) . "...\n";
    } else {
        echo "✅ Акт агрессивности: отсутствует (–)\n";
    }
} else {
    echo "✅ Акт агрессивности: не найден\n";
}

if (preg_match('/выбытие\s*\(причина[,\s]+дата\)[:\s]+(.+?)(?:ветеринарный|адрес\s+и\s+описание|$)/ui', $text, $matches)) {
    $outcome = trim($matches[1]);
    if (!in_array($outcome, ['–', '-', ''])) {
        echo "✅ Выбытие: " . $outcome . "\n";
    } else {
        echo "✅ Выбытие: не указано (–)\n";
    }
} else {
    echo "✅ Выбытие: не найдено\n";
}

if (preg_match('/ветеринарный\s+сопроводительный\s+документ\s*\(дата[,\s]+№\)[:\s]+(.+?)(?:адрес\s+и\s+описание|$)/ui', $text, $matches)) {
    $vsd = trim($matches[1]);
    if (!in_array($vsd, ['–', '-', ''])) {
        echo "✅ Вет. сопроводительный документ: " . $vsd . "\n";
    } else {
        echo "✅ Вет. сопроводительный документ: не указан (–)\n";
    }
} else {
    echo "✅ Вет. сопроводительный документ: не найден\n";
}

if (preg_match('/адрес\s+и\s+описание\s+места\s+возвращения[:\s\(]*размещения[:\s\)]*[:\s]+(.+?)$/ui', $text, $matches)) {
    $release = trim($matches[1]);
    if (!in_array($release, ['–', '-', ''])) {
        echo "✅ Адрес возврата: " . mb_substr($release, 0, 60) . "...\n";
    } else {
        echo "✅ Адрес возврата: не указан (–)\n";
    }
} else {
    echo "✅ Адрес возврата: не найден\n";
}

echo "\n" . str_repeat('=', 70) . "\n";
